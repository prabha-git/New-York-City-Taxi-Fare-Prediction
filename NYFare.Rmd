---
title: "New York Taxi fare - prediction"
---

 
 Loading required libraries
```{r}
library(dplyr)
library(readr)
library(geosphere)
library(caret)
library(lubridate)
```


Loading train and test dataset
```{r cache=TRUE,cache.lazy = FALSE}
train=read_csv('datasets/train.csv')
test=read_csv('datasets/test.csv',col_types = list(key=col_character()))
```


### Randomly select 50k rows from the train dataset 
### Remove outliers
### Remove NAs
```{r}
train_1=train[sample(1:nrow(train),50000,FALSE,NULL),] %>% 
  
  rowwise() %>% 
  
  #drop rows if any column has NA's
  na.omit() %>% 
  
  
  #remove wrong latitude and longitude
  filter (pickup_longitude > -80 & pickup_longitude < -60) %>%
  
  filter(pickup_latitude>30 & pickup_latitude<50) %>%
  
  filter(dropoff_longitude  > -80 & dropoff_longitude < -60) %>%
  
  filter(dropoff_latitude > 30 & dropoff_latitude < 50) %>%
  
  #remove negative fare amounts
  filter(fare_amount > 0) %>% 
  
  #remove passenger count =0
  filter(passenger_count>0)
  
```



```{r}
table(train_1$passenger_count)
```




### Adding the new features / converting as date data type

```{r}
train_2=train_1 %>% 
  
  rowwise() %>% 
  
  # casting as pickup date time
  mutate(pickup_datetime=substring(pickup_datetime,1,nchar(pickup_datetime)-4)) %>% 
  
  mutate(pickup_datetime=ymd_hms(pickup_datetime,tz="UTC")) %>% 
  
  mutate(pickup_datetime_est=with_tz(pickup_datetime, tzone = "America/New_York"))  %>% 
  
  
  
  
    # casting as pickup date time
  mutate(dropoff_datetime=substring(dropoff_datetime,1,nchar(dropoff_datetime)-4)) %>% 
  
  mutate(dropoff_datetime=ymd_hms(dropoff_datetime,tz="UTC")) %>% 
  
  mutate(dropoff_datetime_est=with_tz(dropoff_datetime, tzone = "America/New_York"))  %>% 
  
  
  #trip duration
  mutate(trip_duration)
  
  
  # adding week day
  mutate(wday=wday(pickup_datetime_est,label=TRUE)) %>% 
  
  # adding pickup hour
  mutate(pickup_hour_est=as.factor(hour(pickup_datetime_est))) %>% 
  
  
  # Adding haversine distance
  mutate(dist_haversine=distHaversine(c(pickup_latitude,pickup_longitude),c(dropoff_latitude,dropoff_longitude
                                                                            ))*0.000621371) 

test1=test %>%   
  rowwise() %>% 
  mutate(pickup_datetime=substring(pickup_datetime,1,nchar(pickup_datetime)-4)) %>% 
  mutate(pickup_datetime=ymd_hms(pickup_datetime,tz="UTC")) %>% 
  mutate(pickup_datetime_est=with_tz(pickup_datetime, tzone = "America/New_York"))  %>% 
  mutate(wday=wday(pickup_datetime_est,label=TRUE)) %>%
  mutate(pickup_hour_est=as.factor(hour(pickup_datetime_est))) %>% 
  mutate(dist_haversine=distHaversine(c(pickup_latitude,pickup_longitude),c(dropoff_latitude,dropoff_longitude))*0.000621371)
```


#Removing the outliers and adding the haversine distance (converted to miles) save it as train_1
```{r}
train_2=train_1 %>%
  
  #drop rows if any column has NA's
  drop_na() %>% 
  
  filter (pickup_longitude > -80 & pickup_longitude < -60) %>%
  
  filter(pickup_latitude>30 & pickup_latitude<50) %>%
  
  filter(dropoff_longitude  > -80 & dropoff_longitude < -60) %>%
  
  filter(dropoff_latitude > 30 & dropoff_latitude < 50) %>%
  
  filter(fare_amount > 0) %>% 
  
  rowwise() %>%
  
  mutate(dist_haversine=distHaversine(c(pickup_latitude,pickup_longitude),c(dropoff_latitude,dropoff_longitude
                                                                            ))*0.000621371)
```




# select only required columns
```{r}
train_3=train_2 %>% select(fare_amount,dist_haversine,wday,pickup_hour_est)
```
# creating train and test dataset
```{r}
index=createDataPartition(train_3$fare_amount,p=0.8,list=FALSE)
train_data=train_3[index,]
test_data=train_3[-index,]
```
#training the model - lm
```{r}
lm_model=train(fare_amount~.,data=train_data,method='lm')
```

Trainign set error
```{r}
sqrt(mean((predict(lm_model,train_data)-train_data$fare_amount)^2))
```
Test set error
```{r}
sqrt(mean((predict(lm_model,test_data)-test_data$fare_amount)^2))
```




#training the model - xgb
```{r}
lm_model=train(fare_amount~.,data=train_data,method='xgbTree')
```

Trainign set error
```{r}
sqrt(mean((predict(lm_model,train_data)-train_data$fare_amount)^2))
```
Test set error
```{r}
sqrt(mean((predict(lm_model,test_data)-test_data$fare_amount)^2))
```









# below coe to write make prediction and write to csv file


# selecting only required column in test 
```{r}
test_1=test1 %>% select(dist_haversine,wday,pickup_hour_est)
```
```{r}
prediction=predict(lm_model,test_1)
```
writing to csv file for submission
```{r}
submission=data.frame(key=as.character(test$key),fare_amount=prediction)
write.csv(submission,file='submissions.csv',row.names=FALSE)
```